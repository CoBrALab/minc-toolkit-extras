#!/bin/bash
#USAGE
#create_civet_image.sh left.obj left_statmap left_FDR5,left_FDR1 right.obj right_statmap right_FDR5,right_FDR1 column_name|column_number output.png

#Automatically generates a standardized view of a brain, using stats files for left and right hemispheres (from RMINC)
#Colourizes objects using stats files, ray traces standard views and them merges them together

set -euo pipefail
#IFS=$'\n\t'

err_report() {
    echo "Error on line $1"
}

trap 'err_report $LINENO' ERR


rmincred='0 1 0 0
0.003937007874016 1 0.003921568627451 0
0.007874015748032 1 0.007843137254902 0
0.011811023622047 1 0.011764705882353 0
0.015748031496063 1 0.015686274509804 0
0.019685039370079 1 0.019607843137255 0
0.023622047244095 1 0.023529411764706 0
0.02755905511811 1 0.027450980392157 0
0.031496062992126 1 0.031372549019608 0
0.035433070866142 1 0.035294117647059 0
0.039370078740158 1 0.03921568627451 0
0.043307086614173 1 0.043137254901961 0
0.047244094488189 1 0.047058823529412 0
0.051181102362205 1 0.050980392156863 0
0.055118110236221 1 0.054901960784314 0
0.059055118110236 1 0.058823529411765 0
0.062992125984252 1 0.062745098039216 0
0.066929133858268 1 0.066666666666667 0
0.070866141732284 1 0.070588235294118 0
0.074803149606299 1 0.074509803921569 0
0.078740157480315 1 0.07843137254902 0
0.082677165354331 1 0.082352941176471 0
0.086614173228347 1 0.086274509803922 0
0.090551181102362 1 0.090196078431373 0
0.094488188976378 1 0.094117647058824 0
0.098425196850394 1 0.098039215686275 0
0.102362204724409 1 0.101960784313725 0
0.106299212598425 1 0.105882352941176 0
0.110236220472441 1 0.109803921568627 0
0.114173228346457 1 0.113725490196078 0
0.118110236220472 1 0.117647058823529 0
0.122047244094488 1 0.12156862745098 0
0.125984251968504 1 0.125490196078431 0
0.12992125984252 1 0.129411764705882 0
0.133858267716535 1 0.133333333333333 0
0.137795275590551 1 0.137254901960784 0
0.141732283464567 1 0.141176470588235 0
0.145669291338583 1 0.145098039215686 0
0.149606299212598 1 0.149019607843137 0
0.153543307086614 1 0.152941176470588 0
0.15748031496063 1 0.156862745098039 0
0.161417322834646 1 0.16078431372549 0
0.165354330708661 1 0.164705882352941 0
0.169291338582677 1 0.168627450980392 0
0.173228346456693 1 0.172549019607843 0
0.177165354330709 1 0.176470588235294 0
0.181102362204724 1 0.180392156862745 0
0.18503937007874 1 0.184313725490196 0
0.188976377952756 1 0.188235294117647 0
0.192913385826772 1 0.192156862745098 0
0.196850393700787 1 0.196078431372549 0
0.200787401574803 1 0.2 0
0.204724409448819 1 0.203921568627451 0
0.208661417322835 1 0.207843137254902 0
0.21259842519685 1 0.211764705882353 0
0.216535433070866 1 0.215686274509804 0
0.220472440944882 1 0.219607843137255 0
0.224409448818898 1 0.223529411764706 0
0.228346456692913 1 0.227450980392157 0
0.232283464566929 1 0.231372549019608 0
0.236220472440945 1 0.235294117647059 0
0.240157480314961 1 0.23921568627451 0
0.244094488188976 1 0.243137254901961 0
0.248031496062992 1 0.247058823529412 0
0.251968503937008 1 0.250980392156863 0
0.255905511811024 1 0.254901960784314 0
0.259842519685039 1 0.258823529411765 0
0.263779527559055 1 0.262745098039216 0
0.267716535433071 1 0.266666666666667 0
0.271653543307087 1 0.270588235294118 0
0.275590551181102 1 0.274509803921569 0
0.279527559055118 1 0.27843137254902 0
0.283464566929134 1 0.282352941176471 0
0.28740157480315 1 0.286274509803922 0
0.291338582677165 1 0.290196078431373 0
0.295275590551181 1 0.294117647058824 0
0.299212598425197 1 0.298039215686275 0
0.303149606299213 1 0.301960784313725 0
0.307086614173228 1 0.305882352941176 0
0.311023622047244 1 0.309803921568627 0
0.31496062992126 1 0.313725490196078 0
0.318897637795276 1 0.317647058823529 0
0.322834645669291 1 0.32156862745098 0
0.326771653543307 1 0.325490196078431 0
0.330708661417323 1 0.329411764705882 0
0.334645669291339 1 0.333333333333333 0
0.338582677165354 1 0.337254901960784 0
0.34251968503937 1 0.341176470588235 0
0.346456692913386 1 0.345098039215686 0
0.350393700787402 1 0.349019607843137 0
0.354330708661417 1 0.352941176470588 0
0.358267716535433 1 0.356862745098039 0
0.362204724409449 1 0.36078431372549 0
0.366141732283465 1 0.364705882352941 0
0.37007874015748 1 0.368627450980392 0
0.374015748031496 1 0.372549019607843 0
0.377952755905512 1 0.376470588235294 0
0.381889763779528 1 0.380392156862745 0
0.385826771653543 1 0.384313725490196 0
0.389763779527559 1 0.388235294117647 0
0.393700787401575 1 0.392156862745098 0
0.397637795275591 1 0.396078431372549 0
0.401574803149606 1 0.4 0
0.405511811023622 1 0.403921568627451 0
0.409448818897638 1 0.407843137254902 0
0.413385826771654 1 0.411764705882353 0
0.417322834645669 1 0.415686274509804 0
0.421259842519685 1 0.419607843137255 0
0.425196850393701 1 0.423529411764706 0
0.429133858267717 1 0.427450980392157 0
0.433070866141732 1 0.431372549019608 0
0.437007874015748 1 0.435294117647059 0
0.440944881889764 1 0.43921568627451 0
0.444881889763779 1 0.443137254901961 0
0.448818897637795 1 0.447058823529412 0
0.452755905511811 1 0.450980392156863 0
0.456692913385827 1 0.454901960784314 0
0.460629921259843 1 0.458823529411765 0
0.464566929133858 1 0.462745098039216 0
0.468503937007874 1 0.466666666666667 0
0.47244094488189 1 0.470588235294118 0
0.476377952755905 1 0.474509803921569 0
0.480314960629921 1 0.47843137254902 0
0.484251968503937 1 0.482352941176471 0
0.488188976377953 1 0.486274509803922 0
0.492125984251969 1 0.490196078431373 0
0.496062992125984 1 0.494117647058824 0
0.5 1 0.498039215686275 0
0.503937007874016 1 0.501960784313725 0
0.507874015748032 1 0.505882352941176 0
0.511811023622047 1 0.509803921568627 0
0.515748031496063 1 0.513725490196078 0
0.519685039370079 1 0.517647058823529 0
0.523622047244094 1 0.52156862745098 0
0.52755905511811 1 0.525490196078431 0
0.531496062992126 1 0.529411764705882 0
0.535433070866142 1 0.533333333333333 0
0.539370078740158 1 0.537254901960784 0
0.543307086614173 1 0.541176470588235 0
0.547244094488189 1 0.545098039215686 0
0.551181102362205 1 0.549019607843137 0
0.55511811023622 1 0.552941176470588 0
0.559055118110236 1 0.556862745098039 0
0.562992125984252 1 0.56078431372549 0
0.566929133858268 1 0.564705882352941 0
0.570866141732283 1 0.568627450980392 0
0.574803149606299 1 0.572549019607843 0
0.578740157480315 1 0.576470588235294 0
0.582677165354331 1 0.580392156862745 0
0.586614173228346 1 0.584313725490196 0
0.590551181102362 1 0.588235294117647 0
0.594488188976378 1 0.592156862745098 0
0.598425196850394 1 0.596078431372549 0
0.602362204724409 1 0.6 0
0.606299212598425 1 0.603921568627451 0
0.610236220472441 1 0.607843137254902 0
0.614173228346457 1 0.611764705882353 0
0.618110236220472 1 0.615686274509804 0
0.622047244094488 1 0.619607843137255 0
0.625984251968504 1 0.623529411764706 0
0.62992125984252 1 0.627450980392157 0
0.633858267716535 1 0.631372549019608 0
0.637795275590551 1 0.635294117647059 0
0.641732283464567 1 0.63921568627451 0
0.645669291338583 1 0.643137254901961 0
0.649606299212598 1 0.647058823529412 0
0.653543307086614 1 0.650980392156863 0
0.65748031496063 1 0.654901960784314 0
0.661417322834646 1 0.658823529411765 0
0.665354330708661 1 0.662745098039216 0
0.669291338582677 1 0.666666666666667 0
0.673228346456693 1 0.670588235294118 0
0.677165354330709 1 0.674509803921569 0
0.681102362204724 1 0.67843137254902 0
0.68503937007874 1 0.682352941176471 0
0.688976377952756 1 0.686274509803922 0
0.692913385826772 1 0.690196078431373 0
0.696850393700787 1 0.694117647058824 0
0.700787401574803 1 0.698039215686274 0
0.704724409448819 1 0.701960784313725 0
0.708661417322835 1 0.705882352941177 0
0.71259842519685 1 0.709803921568627 0
0.716535433070866 1 0.713725490196078 0
0.720472440944882 1 0.717647058823529 0
0.724409448818898 1 0.72156862745098 0
0.728346456692913 1 0.725490196078431 0
0.732283464566929 1 0.729411764705882 0
0.736220472440945 1 0.733333333333333 0
0.740157480314961 1 0.737254901960784 0
0.744094488188976 1 0.741176470588235 0
0.748031496062992 1 0.745098039215686 0
0.751968503937008 1 0.749019607843137 0
0.755905511811024 1 0.752941176470588 0
0.759842519685039 1 0.756862745098039 0
0.763779527559055 1 0.76078431372549 0
0.767716535433071 1 0.764705882352941 0
0.771653543307087 1 0.768627450980392 0
0.775590551181102 1 0.772549019607843 0
0.779527559055118 1 0.776470588235294 0
0.783464566929134 1 0.780392156862745 0
0.78740157480315 1 0.784313725490196 0
0.791338582677165 1 0.788235294117647 0
0.795275590551181 1 0.792156862745098 0
0.799212598425197 1 0.796078431372549 0
0.803149606299213 1 0.8 0
0.807086614173228 1 0.803921568627451 0
0.811023622047244 1 0.807843137254902 0
0.81496062992126 1 0.811764705882353 0
0.818897637795276 1 0.815686274509804 0
0.822834645669291 1 0.819607843137255 0
0.826771653543307 1 0.823529411764706 0
0.830708661417323 1 0.827450980392157 0
0.834645669291339 1 0.831372549019608 0
0.838582677165354 1 0.835294117647059 0
0.84251968503937 1 0.83921568627451 0
0.846456692913386 1 0.843137254901961 0
0.850393700787402 1 0.847058823529412 0
0.854330708661417 1 0.850980392156863 0
0.858267716535433 1 0.854901960784314 0
0.862204724409449 1 0.858823529411765 0
0.866141732283464 1 0.862745098039216 0
0.87007874015748 1 0.866666666666667 0
0.874015748031496 1 0.870588235294118 0
0.877952755905512 1 0.874509803921569 0
0.881889763779527 1 0.87843137254902 0
0.885826771653543 1 0.882352941176471 0
0.889763779527559 1 0.886274509803922 0
0.893700787401575 1 0.890196078431372 0
0.89763779527559 1 0.894117647058824 0
0.901574803149606 1 0.898039215686275 0
0.905511811023622 1 0.901960784313726 0
0.909448818897638 1 0.905882352941176 0
0.913385826771654 1 0.909803921568627 0
0.917322834645669 1 0.913725490196078 0
0.921259842519685 1 0.917647058823529 0
0.925196850393701 1 0.92156862745098 0
0.929133858267717 1 0.925490196078431 0
0.933070866141732 1 0.929411764705882 0
0.937007874015748 1 0.933333333333333 0
0.940944881889764 1 0.937254901960784 0
0.944881889763779 1 0.941176470588235 0
0.948818897637795 1 0.945098039215686 0
0.952755905511811 1 0.949019607843137 0
0.956692913385827 1 0.952941176470588 0
0.960629921259842 1 0.956862745098039 0
0.964566929133858 1 0.96078431372549 0
0.968503937007874 1 0.964705882352941 0
0.97244094488189 1 0.968627450980392 0
0.976377952755906 1 0.972549019607843 0
0.980314960629921 1 0.976470588235294 0
0.984251968503937 1 0.980392156862745 0
0.988188976377953 1 0.984313725490196 0
0.992125984251969 1 0.988235294117647 0
0.996062992125984 1 0.992156862745098 0
1 1 1 0'

rmincblue='0 0 0 1
0.003937007874016 0 0 1
0.007874015748032 0 0.003921568627451 1
0.011811023622047 0 0.007843137254902 1
0.015748031496063 0 0.011764705882353 1
0.019685039370079 0 0.015686274509804 1
0.023622047244095 0 0.019607843137255 1
0.02755905511811 0 0.023529411764706 1
0.031496062992126 0 0.027450980392157 1
0.035433070866142 0 0.031372549019608 1
0.039370078740158 0 0.035294117647059 1
0.043307086614173 0 0.03921568627451 1
0.047244094488189 0 0.043137254901961 1
0.051181102362205 0 0.047058823529412 1
0.055118110236221 0 0.050980392156863 1
0.059055118110236 0 0.054901960784314 1
0.062992125984252 0 0.058823529411765 1
0.066929133858268 0 0.062745098039216 1
0.070866141732284 0 0.066666666666667 1
0.074803149606299 0 0.070588235294118 1
0.078740157480315 0 0.074509803921569 1
0.082677165354331 0 0.07843137254902 1
0.086614173228347 0 0.082352941176471 1
0.090551181102362 0 0.086274509803922 1
0.094488188976378 0 0.090196078431373 1
0.098425196850394 0 0.094117647058824 1
0.102362204724409 0 0.098039215686275 1
0.106299212598425 0 0.101960784313725 1
0.110236220472441 0 0.105882352941176 1
0.114173228346457 0 0.105882352941176 1
0.118110236220472 0 0.109803921568627 1
0.122047244094488 0 0.113725490196078 1
0.125984251968504 0 0.117647058823529 1
0.12992125984252 0 0.12156862745098 1
0.133858267716535 0 0.125490196078431 1
0.137795275590551 0 0.129411764705882 1
0.141732283464567 0 0.133333333333333 1
0.145669291338583 0 0.137254901960784 1
0.149606299212598 0 0.141176470588235 1
0.153543307086614 0 0.145098039215686 1
0.15748031496063 0 0.149019607843137 1
0.161417322834646 0 0.152941176470588 1
0.165354330708661 0 0.156862745098039 1
0.169291338582677 0 0.16078431372549 1
0.173228346456693 0 0.164705882352941 1
0.177165354330709 0 0.168627450980392 1
0.181102362204724 0 0.172549019607843 1
0.18503937007874 0 0.176470588235294 1
0.188976377952756 0 0.180392156862745 1
0.192913385826772 0 0.184313725490196 1
0.196850393700787 0 0.188235294117647 1
0.200787401574803 0 0.192156862745098 1
0.204724409448819 0 0.196078431372549 1
0.208661417322835 0 0.2 1
0.21259842519685 0 0.203921568627451 1
0.216535433070866 0 0.207843137254902 1
0.220472440944882 0 0.211764705882353 1
0.224409448818898 0 0.211764705882353 1
0.228346456692913 0 0.215686274509804 1
0.232283464566929 0 0.219607843137255 1
0.236220472440945 0 0.223529411764706 1
0.240157480314961 0 0.227450980392157 1
0.244094488188976 0 0.231372549019608 1
0.248031496062992 0 0.235294117647059 1
0.251968503937008 0 0.23921568627451 1
0.255905511811024 0 0.243137254901961 1
0.259842519685039 0 0.247058823529412 1
0.263779527559055 0 0.250980392156863 1
0.267716535433071 0 0.254901960784314 1
0.271653543307087 0 0.258823529411765 1
0.275590551181102 0 0.262745098039216 1
0.279527559055118 0 0.266666666666667 1
0.283464566929134 0 0.270588235294118 1
0.28740157480315 0 0.274509803921569 1
0.291338582677165 0 0.27843137254902 1
0.295275590551181 0 0.282352941176471 1
0.299212598425197 0 0.286274509803922 1
0.303149606299213 0 0.290196078431373 1
0.307086614173228 0 0.294117647058824 1
0.311023622047244 0 0.298039215686275 1
0.31496062992126 0 0.301960784313725 1
0.318897637795276 0 0.305882352941176 1
0.322834645669291 0 0.309803921568627 1
0.326771653543307 0 0.313725490196078 1
0.330708661417323 0 0.317647058823529 1
0.334645669291339 0 0.317647058823529 1
0.338582677165354 0 0.32156862745098 1
0.34251968503937 0 0.325490196078431 1
0.346456692913386 0 0.329411764705882 1
0.350393700787402 0 0.333333333333333 1
0.354330708661417 0 0.337254901960784 1
0.358267716535433 0 0.341176470588235 1
0.362204724409449 0 0.345098039215686 1
0.366141732283465 0 0.349019607843137 1
0.37007874015748 0 0.352941176470588 1
0.374015748031496 0 0.356862745098039 1
0.377952755905512 0 0.36078431372549 1
0.381889763779528 0 0.364705882352941 1
0.385826771653543 0 0.368627450980392 1
0.389763779527559 0 0.372549019607843 1
0.393700787401575 0 0.376470588235294 1
0.397637795275591 0 0.380392156862745 1
0.401574803149606 0 0.384313725490196 1
0.405511811023622 0 0.388235294117647 1
0.409448818897638 0 0.392156862745098 1
0.413385826771654 0 0.396078431372549 1
0.417322834645669 0 0.4 1
0.421259842519685 0 0.403921568627451 1
0.425196850393701 0 0.407843137254902 1
0.429133858267717 0 0.411764705882353 1
0.433070866141732 0 0.415686274509804 1
0.437007874015748 0 0.419607843137255 1
0.440944881889764 0 0.423529411764706 1
0.444881889763779 0 0.423529411764706 1
0.448818897637795 0 0.427450980392157 1
0.452755905511811 0 0.431372549019608 1
0.456692913385827 0 0.435294117647059 1
0.460629921259843 0 0.43921568627451 1
0.464566929133858 0 0.443137254901961 1
0.468503937007874 0 0.447058823529412 1
0.47244094488189 0 0.450980392156863 1
0.476377952755905 0 0.454901960784314 1
0.480314960629921 0 0.458823529411765 1
0.484251968503937 0 0.462745098039216 1
0.488188976377953 0 0.466666666666667 1
0.492125984251969 0 0.470588235294118 1
0.496062992125984 0 0.474509803921569 1
0.5 0 0.47843137254902 1
0.503937007874016 0 0.482352941176471 1
0.507874015748032 0 0.486274509803922 1
0.511811023622047 0 0.490196078431373 1
0.515748031496063 0 0.494117647058824 1
0.519685039370079 0 0.498039215686275 1
0.523622047244094 0 0.501960784313725 1
0.52755905511811 0 0.505882352941176 1
0.531496062992126 0 0.509803921568627 1
0.535433070866142 0 0.513725490196078 1
0.539370078740158 0 0.517647058823529 1
0.543307086614173 0 0.52156862745098 1
0.547244094488189 0 0.525490196078431 1
0.551181102362205 0 0.529411764705882 1
0.55511811023622 0 0.533333333333333 1
0.559055118110236 0 0.533333333333333 1
0.562992125984252 0 0.537254901960784 1
0.566929133858268 0 0.541176470588235 1
0.570866141732283 0 0.545098039215686 1
0.574803149606299 0 0.549019607843137 1
0.578740157480315 0 0.552941176470588 1
0.582677165354331 0 0.556862745098039 1
0.586614173228346 0 0.56078431372549 1
0.590551181102362 0 0.564705882352941 1
0.594488188976378 0 0.568627450980392 1
0.598425196850394 0 0.572549019607843 1
0.602362204724409 0 0.576470588235294 1
0.606299212598425 0 0.580392156862745 1
0.610236220472441 0 0.584313725490196 1
0.614173228346457 0 0.588235294117647 1
0.618110236220472 0 0.592156862745098 1
0.622047244094488 0 0.596078431372549 1
0.625984251968504 0 0.6 1
0.62992125984252 0 0.603921568627451 1
0.633858267716535 0 0.607843137254902 1
0.637795275590551 0 0.611764705882353 1
0.641732283464567 0 0.615686274509804 1
0.645669291338583 0 0.619607843137255 1
0.649606299212598 0 0.623529411764706 1
0.653543307086614 0 0.627450980392157 1
0.65748031496063 0 0.631372549019608 1
0.661417322834646 0 0.635294117647059 1
0.665354330708661 0 0.63921568627451 1
0.669291338582677 0 0.63921568627451 1
0.673228346456693 0 0.643137254901961 1
0.677165354330709 0 0.647058823529412 1
0.681102362204724 0 0.650980392156863 1
0.68503937007874 0 0.654901960784314 1
0.688976377952756 0 0.658823529411765 1
0.692913385826772 0 0.662745098039216 1
0.696850393700787 0 0.666666666666667 1
0.700787401574803 0 0.670588235294118 1
0.704724409448819 0 0.674509803921569 1
0.708661417322835 0 0.67843137254902 1
0.71259842519685 0 0.682352941176471 1
0.716535433070866 0 0.686274509803922 1
0.720472440944882 0 0.690196078431373 1
0.724409448818898 0 0.694117647058824 1
0.728346456692913 0 0.698039215686274 1
0.732283464566929 0 0.701960784313725 1
0.736220472440945 0 0.705882352941177 1
0.740157480314961 0 0.709803921568627 1
0.744094488188976 0 0.713725490196078 1
0.748031496062992 0 0.717647058823529 1
0.751968503937008 0 0.72156862745098 1
0.755905511811024 0 0.725490196078431 1
0.759842519685039 0 0.729411764705882 1
0.763779527559055 0 0.733333333333333 1
0.767716535433071 0 0.737254901960784 1
0.771653543307087 0 0.741176470588235 1
0.775590551181102 0 0.745098039215686 1
0.779527559055118 0 0.745098039215686 1
0.783464566929134 0 0.749019607843137 1
0.78740157480315 0 0.752941176470588 1
0.791338582677165 0 0.756862745098039 1
0.795275590551181 0 0.76078431372549 1
0.799212598425197 0 0.764705882352941 1
0.803149606299213 0 0.768627450980392 1
0.807086614173228 0 0.772549019607843 1
0.811023622047244 0 0.776470588235294 1
0.81496062992126 0 0.780392156862745 1
0.818897637795276 0 0.784313725490196 1
0.822834645669291 0 0.788235294117647 1
0.826771653543307 0 0.792156862745098 1
0.830708661417323 0 0.796078431372549 1
0.834645669291339 0 0.8 1
0.838582677165354 0 0.803921568627451 1
0.84251968503937 0 0.807843137254902 1
0.846456692913386 0 0.811764705882353 1
0.850393700787402 0 0.815686274509804 1
0.854330708661417 0 0.819607843137255 1
0.858267716535433 0 0.823529411764706 1
0.862204724409449 0 0.827450980392157 1
0.866141732283464 0 0.831372549019608 1
0.87007874015748 0 0.835294117647059 1
0.874015748031496 0 0.83921568627451 1
0.877952755905512 0 0.843137254901961 1
0.881889763779527 0 0.847058823529412 1
0.885826771653543 0 0.850980392156863 1
0.889763779527559 0 0.850980392156863 1
0.893700787401575 0 0.854901960784314 1
0.89763779527559 0 0.858823529411765 1
0.901574803149606 0 0.862745098039216 1
0.905511811023622 0 0.866666666666667 1
0.909448818897638 0 0.870588235294118 1
0.913385826771654 0 0.874509803921569 1
0.917322834645669 0 0.87843137254902 1
0.921259842519685 0 0.882352941176471 1
0.925196850393701 0 0.886274509803922 1
0.929133858267717 0 0.890196078431372 1
0.933070866141732 0 0.894117647058824 1
0.937007874015748 0 0.898039215686275 1
0.940944881889764 0 0.901960784313726 1
0.944881889763779 0 0.905882352941176 1
0.948818897637795 0 0.909803921568627 1
0.952755905511811 0 0.913725490196078 1
0.956692913385827 0 0.917647058823529 1
0.960629921259842 0 0.92156862745098 1
0.964566929133858 0 0.925490196078431 1
0.968503937007874 0 0.929411764705882 1
0.97244094488189 0 0.933333333333333 1
0.976377952755906 0 0.937254901960784 1
0.980314960629921 0 0.941176470588235 1
0.984251968503937 0 0.945098039215686 1
0.988188976377953 0 0.949019607843137 1
0.992125984251969 0 0.952941176470588 1
0.996062992125984 0 0.956862745098039 1
1 0 0.96078431372549 1'

awkscriptcsv='BEGIN{
    OFS=FS=","
    split(target, t_targets, ",")
    for (i in t_targets)
        targets[t_targets[i]] = i
}
NR==1 {
    for (i = 1; i <= NF; i++) head[i] = gensub(/\"/,  "", "g", $i)
}

NR !=1{
    for (i = 1; i <= NF; i++) {
        if (head[i] in targets){
            print $i
        }
    }
}'

awkscriptvertstats='BEGIN{
    OFS=FS=" "
    split(target, t_targets, ",")
    for (i in t_targets)
        targets[t_targets[i]] = i
}
NR==3 {
    for (i = 1; i <= NF; i++) head[i] = $i
}

NR >3{
    for (i = 1; i <= NF; i++) {
        if (head[i] in targets){
            print $i
        }
    }
}'

if [[ $# -ne 8 ]]; then
    echo 'Usage: create_civet_image.sh left.obj left_statmap left_FDR5,left_FDR1 right.obj right_statmap right_FDR5,right_FDR1 column_name|column_number output.png'
    exit
fi


TMPDIR=$(mktemp -d)
leftbrain=$1
leftstatmap=$2
leftFDR5=$(echo $3 | cut -d"," -f 1)
leftFDR1=$(echo $3 | cut -d"," -f 2)
rightbrain=$4
rightstatmap=$5
rightFDR5=$(echo $6 | cut -d"," -f 1)
rightFDR1=$(echo $6 | cut -d"," -f 2)
column=$7
output=$8

#Check file type
filename=$(basename $leftstatmap)
extension="${filename##*.}"

if [[ $(head -1 $leftbrain | tr " " "\n" | tail -1) == 40962 ]]; then
    __mask="/opt/quarantine/resources/CIVET-CC-mask.txt"
else
    __mask="/opt/quarantine/resources/CIVET/CIVET_2.0_mask_left.txt"
fi

#Pick out column, multiply by mask and store in new tempfile
case $extension in
    csv)
        awk -v target=$column -f <(printf "$awkscriptcsv") $leftstatmap | paste -d\* $__mask - | sed 's/[eE]+\{0,1\}/*10^/g' | bc > $TMPDIR/$(basename $leftstatmap)
        awk -v target=$column -f <(printf "$awkscriptcsv") $rightstatmap | paste -d\* $__mask - | sed 's/[eE]+\{0,1\}/*10^/g' | bc > $TMPDIR/$(basename $rightstatmap)
        ;;
    vertstats)
        awk -v target=$column -f <(printf "$awkscriptvertstats") $leftstatmap | paste -d\* $__mask - | sed 's/[eE]+\{0,1\}/*10^/g' | bc > $TMPDIR/$(basename $leftstatmap)
        awk -v target=$column -f <(printf "$awkscriptvertstats") $rightstatmap | paste -d\* $__mask - | sed 's/[eE]+\{0,1\}/*10^/g' | bc > $TMPDIR/$(basename $rightstatmap)
        ;;
    txt)
        cut -d " " -f $column $leftstatmap |  paste -d\* $__mask - | sed 's/[eE]+\{0,1\}/*10^/g' | bc > $TMPDIR/$(basename $leftstatmap)
        cut -d " " -f $column $rightstatmap | paste -d\* $__mask - | sed 's/[eE]+\{0,1\}/*10^/g' | bc > $TMPDIR/$(basename $rightstatmap)
        ;;
esac


#Redefine statmap to masked tempfile
leftstatmap=$TMPDIR/$(basename $leftstatmap)
rightstatmap=$TMPDIR/$(basename $rightstatmap)

printf '%s %s %s %s\n' $rmincred > $TMPDIR/rmincred.map
printf '%s %s %s %s\n' $rmincblue > $TMPDIR/rmincblue.map

#Colourize left
if (( $(echo "$leftFDR5 <= $(sort -g $leftstatmap | tail -1)" | bc) ))
then
    colour_object $leftbrain $leftstatmap $TMPDIR/left_pos.obj user $TMPDIR/rmincred.map $leftFDR5 $leftFDR1 white yellow replace
else
    cp $leftbrain $TMPDIR/left_pos.obj
fi

if (( $(echo "-$leftFDR5 >= $(sort -g $leftstatmap  | head -1)" | bc) ))
then
    colour_object $TMPDIR/left_pos.obj $leftstatmap $TMPDIR/left_comb.obj user $TMPDIR/rmincblue.map -$leftFDR5 -$leftFDR1 transparent "0 0.96078431372549 1" composite
else
    cp  $TMPDIR/left_pos.obj $TMPDIR/left_comb.obj
fi

#Colourize right
if (( $(echo "$rightFDR5 <= $(sort -g $rightstatmap | tail -1)" | bc) ))
then
    colour_object $rightbrain $rightstatmap $TMPDIR/right_pos.obj user $TMPDIR/rmincred.map $rightFDR5 $rightFDR1 white yellow replace
else
    cp $rightbrain $TMPDIR/right_pos.obj
fi

if (( $(echo "-$rightFDR5 >= $(sort -g $rightstatmap  | head -1)" | bc) ))
then
    colour_object $TMPDIR/right_pos.obj $rightstatmap $TMPDIR/right_comb.obj user $TMPDIR/rmincblue.map -$rightFDR5 -$rightFDR1 transparent "0 0.96078431372549 1" composite
else
    cp $TMPDIR/right_pos.obj $TMPDIR/right_comb.obj
fi

#Generate views
echo """ray_trace -output $TMPDIR/bottom.rgb $TMPDIR/left_comb.obj $TMPDIR/right_comb.obj -size 1000 1000 -crop -sup 3 -bg black -bottom -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1
ray_trace -output $TMPDIR/top.rgb $TMPDIR/left_comb.obj $TMPDIR/right_comb.obj -size 1000 1000 -crop -sup 3 -bg black -top -shadows -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1
ray_trace -output $TMPDIR/front.rgb $TMPDIR/left_comb.obj $TMPDIR/right_comb.obj -size 1000 1000 -crop -sup 3 -bg black -front -shadows -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1
ray_trace -output $TMPDIR/back.rgb $TMPDIR/left_comb.obj $TMPDIR/right_comb.obj -size 1000 1000 -crop -sup 3 -bg black -back -shadows -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1
ray_trace -output $TMPDIR/left_medial.rgb $TMPDIR/left_comb.obj -size 1000 1000 -crop -sup 3 -bg black -right -shadows -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1
ray_trace -output $TMPDIR/left_lateral.rgb $TMPDIR/left_comb.obj -size 1000 1000 -crop -sup 3 -bg black -left -shadows -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1
ray_trace -output $TMPDIR/right_medial.rgb $TMPDIR/right_comb.obj -size 1000 1000 -crop -sup 3 -bg black -left -shadows -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1
ray_trace -output $TMPDIR/right_lateral.rgb $TMPDIR/right_comb.obj -size 1000 1000 -crop -sup 3 -bg black  -right -shadows -directional 1 -1 -1 1 1 1 -directional -1 -1 -1 1 1 1 -directional -1 -1 1 1 1 1""" | parallel

#Create pngs
for file in $TMPDIR/*.rgb
do
    echo convert $file $TMPDIR/$(basename $file rgb)png
done | parallel -j8

#Create colourbars
convert xc:rgb\(0,245,255\) xc:blue -append -filter Cubic -resize 30x600\! -bordercolor black -border 2x2 -bordercolor white -border 2x2 $TMPDIR/coldmetalinv.png
convert xc:yellow xc:red -append -filter Cubic -resize 30x600\! -bordercolor black -border 2x2 -bordercolor white -border 2x2 $TMPDIR/redmetalinv.png

#Create combined figure
convert -gravity Center -background black +append $TMPDIR/left_medial.png $TMPDIR/right_medial.png $TMPDIR/1.png
convert -gravity Center -background black +append $TMPDIR/left_lateral.png $TMPDIR/right_lateral.png $TMPDIR/2.png
convert -gravity Center -background black +append $TMPDIR/top.png $TMPDIR/bottom.png $TMPDIR/3.png
convert -gravity Center -background black +append $TMPDIR/front.png $TMPDIR/back.png $TMPDIR/4.png
convert $TMPDIR/1.png $TMPDIR/2.png $TMPDIR/3.png $TMPDIR/4.png -gravity Center -background black -append $TMPDIR/unlabelled.png

convert $TMPDIR/unlabelled.png \
-page +1364+1685 $TMPDIR/coldmetalinv.png \
-page +199+1685 $TMPDIR/redmetalinv.png \
-stroke  none   -fill white  -pointsize 45 -annotate +1410+2285 'FDR 5%' \
-stroke  none   -fill white  -pointsize 45 -annotate +1410+1725 'FDR 1%' \
-stroke  none   -fill white  -pointsize 45 -annotate +5+2285 'FDR 5%' \
-stroke  none   -fill white  -pointsize 45 -annotate +5+1725 'FDR 1%' \
-stroke  none   -fill white  -pointsize 45 -gravity north -annotate 0 "$column" \
-flatten $output
